# Backend Architecture: Data Flow Diagram

## Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           KUBERNETES CLUSTER                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         INGRESS (NGINX)                                 â”‚ â”‚
â”‚  â”‚  Routes: /api â†’ Backend, /socket.io â†’ Backend, / â†’ Frontend           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚               â”‚                                        â”‚                     â”‚
â”‚               â–¼                                        â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Frontend Pods      â”‚                  â”‚  Backend Pods       â”‚          â”‚
â”‚  â”‚  (Next.js)          â”‚                  â”‚  (Node.js/Express)  â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚  â”‚  â”‚ Pod 1         â”‚  â”‚                  â”‚  â”‚ Pod 1         â”‚  â”‚          â”‚
â”‚  â”‚  â”‚ Port: 3000    â”‚  â”‚                  â”‚  â”‚ Port: 5000    â”‚  â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚  â”‚ - HTTP API    â”‚  â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚  â”‚ - Socket.io   â”‚  â”‚          â”‚
â”‚  â”‚  â”‚ Pod 2         â”‚  â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚  â”‚  â”‚ Port: 3000    â”‚  â”‚                  â”‚          â”‚          â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚ Pod 2         â”‚  â”‚          â”‚
â”‚                                            â”‚  â”‚ Port: 5000    â”‚  â”‚          â”‚
â”‚                                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                       â”‚                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                    â”‚                                  â”‚             â”‚       â”‚
â”‚                    â–¼                                  â–¼             â–¼       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚         â”‚   REDIS CACHE        â”‚         â”‚   RABBITMQ MESSAGE QUEUE     â”‚  â”‚
â”‚         â”‚   (In-Memory)        â”‚         â”‚   (Persistent Queue)         â”‚  â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚         â”‚ Purpose:             â”‚         â”‚ Purpose:                     â”‚  â”‚
â”‚         â”‚ - Session storage    â”‚         â”‚ - Async message processing   â”‚  â”‚
â”‚         â”‚ - Real-time messages â”‚         â”‚ - Decouple write operations  â”‚  â”‚
â”‚         â”‚ - Cache recent data  â”‚         â”‚ - Ensure message delivery    â”‚  â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚         â”‚ Data Structure:      â”‚         â”‚ Queue: message_save          â”‚  â”‚
â”‚         â”‚ room:{id}:messages   â”‚         â”‚ - Durable: true              â”‚  â”‚
â”‚         â”‚ (List, last 100)     â”‚         â”‚ - Persistent: true           â”‚  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                                 â”‚                      â”‚
â”‚                    â”‚                                 â–¼                      â”‚
â”‚                    â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                    â”‚                     â”‚  Worker Pods         â”‚          â”‚
â”‚                    â”‚                     â”‚  (Message Consumer)  â”‚          â”‚
â”‚                    â”‚                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚                    â”‚                     â”‚  â”‚ Worker 1       â”‚  â”‚          â”‚
â”‚                    â”‚                     â”‚  â”‚ - Consume queueâ”‚  â”‚          â”‚
â”‚                    â”‚                     â”‚  â”‚ - Write to DB  â”‚  â”‚          â”‚
â”‚                    â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚                    â”‚                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚                    â”‚                     â”‚  â”‚ Worker 2       â”‚  â”‚          â”‚
â”‚                    â”‚                     â”‚  â”‚ - Consume queueâ”‚  â”‚          â”‚
â”‚                    â”‚                     â”‚  â”‚ - Write to DB  â”‚  â”‚          â”‚
â”‚                    â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚                    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                    â”‚                                 â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                                                      â”‚          â”‚           â”‚
â”‚                                                      â–¼          â–¼           â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                                          â”‚  MongoDB StatefulSet       â”‚     â”‚
â”‚                                          â”‚  (Persistent Database)     â”‚     â”‚
â”‚                                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚                                          â”‚ Collections:               â”‚     â”‚
â”‚                                          â”‚ - messages                 â”‚     â”‚
â”‚                                          â”‚ - users                    â”‚     â”‚
â”‚                                          â”‚ - rooms                    â”‚     â”‚
â”‚                                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚                                          â”‚ Persistent Volume: 10Gi    â”‚     â”‚
â”‚                                          â”‚ Port: 27017                â”‚     â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Detailed Message Flow

### Scenario: User Sends a Chat Message

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: User sends message via Socket.io                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Backend Pod receives message                                        â”‚
â”‚                                                                              â”‚
â”‚  socket.on('send_message', async ({ roomId, content }) => {                â”‚
â”‚    const messageData = {                                                    â”‚
â”‚      sender: socket.username,                                               â”‚
â”‚      roomId: roomId,                                                        â”‚
â”‚      content: content,                                                      â”‚
â”‚      timestamp: new Date()                                                  â”‚
â”‚    };                                                                       â”‚
â”‚                                                                              â”‚
â”‚    // PARALLEL OPERATIONS:                                                  â”‚
â”‚    â”œâ”€â–º [A] Store in Redis (fast, in-memory)                                â”‚
â”‚    â”œâ”€â–º [B] Emit to Socket.io room (real-time delivery)                     â”‚
â”‚    â””â”€â–º [C] Publish to RabbitMQ (async persistence)                         â”‚
â”‚  });                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                      â”‚                      â”‚
           â”‚                      â”‚                      â”‚
    [A]    â”‚               [B]    â”‚               [C]    â”‚
           â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REDIS CACHE     â”‚   â”‚  SOCKET.IO       â”‚   â”‚  RABBITMQ QUEUE  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Operation:       â”‚   â”‚ Operation:       â”‚   â”‚ Operation:       â”‚
â”‚ LPUSH            â”‚   â”‚ io.to(roomId)    â”‚   â”‚ channel.send     â”‚
â”‚ room:123:msgs    â”‚   â”‚   .emit()        â”‚   â”‚ ToQueue()        â”‚
â”‚                  â”‚   â”‚                  â”‚   â”‚                  â”‚
â”‚ Result:          â”‚   â”‚ Result:          â”‚   â”‚ Result:          â”‚
â”‚ Message stored   â”‚   â”‚ All users in     â”‚   â”‚ Message queued   â”‚
â”‚ in list          â”‚   â”‚ room receive     â”‚   â”‚ for persistence  â”‚
â”‚ (last 100 kept)  â”‚   â”‚ message          â”‚   â”‚ (durable)        â”‚
â”‚                  â”‚   â”‚ INSTANTLY        â”‚   â”‚                  â”‚
â”‚ Time: ~1ms       â”‚   â”‚ Time: ~5ms       â”‚   â”‚ Time: ~2ms       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â”‚ Queue waits
                                                        â”‚ for worker
                                                        â–¼
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚  WORKER POD      â”‚
                                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                              â”‚ Operation:       â”‚
                                              â”‚ channel.consume  â”‚
                                              â”‚                  â”‚
                                              â”‚ 1. Dequeue msg   â”‚
                                              â”‚ 2. Parse JSON    â”‚
                                              â”‚ 3. Create model  â”‚
                                              â”‚ 4. Save to DB    â”‚
                                              â”‚ 5. ACK message   â”‚
                                              â”‚                  â”‚
                                              â”‚ Time: ~50-100ms  â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚  MONGODB         â”‚
                                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                              â”‚ Operation:       â”‚
                                              â”‚ INSERT INTO      â”‚
                                              â”‚ messages         â”‚
                                              â”‚                  â”‚
                                              â”‚ Result:          â”‚
                                              â”‚ Message          â”‚
                                              â”‚ persisted        â”‚
                                              â”‚ permanently      â”‚
                                              â”‚                  â”‚
                                              â”‚ Time: ~20-50ms   â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Responsibilities

### Backend Pods (Node.js/Express + Socket.io)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND POD                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Responsibilities:                                            â”‚
â”‚ âœ“ Handle HTTP API requests (/api/auth, /api/rooms, etc.)   â”‚
â”‚ âœ“ Manage WebSocket connections (Socket.io)                  â”‚
â”‚ âœ“ Store messages in Redis (fast cache)                      â”‚
â”‚ âœ“ Broadcast messages to connected clients (real-time)       â”‚
â”‚ âœ“ Publish messages to RabbitMQ (async persistence)          â”‚
â”‚ âœ“ Read recent messages from Redis (fast retrieval)          â”‚
â”‚                                                              â”‚
â”‚ Environment Variables:                                       â”‚
â”‚ - MONGO_URL: mongodb://msgapp-mongodb:27017/chatapp        â”‚
â”‚ - REDIS_HOST: msgapp-redis                                  â”‚
â”‚ - REDIS_PORT: 6379                                          â”‚
â”‚ - RABBITMQ_HOST: msgapp-rabbitmq                            â”‚
â”‚ - RABBITMQ_USER: msgapp                                     â”‚
â”‚ - RABBITMQ_PASS: ********                                   â”‚
â”‚                                                              â”‚
â”‚ Scaling: 2-20 pods (HPA based on CPU/Memory)                â”‚
â”‚ Sticky Sessions: Enabled (for Socket.io)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Redis Cache

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REDIS CACHE                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Purpose: Fast, in-memory data store                          â”‚
â”‚                                                              â”‚
â”‚ Data Stored:                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Key: room:123:messages                                â”‚    â”‚
â”‚ â”‚ Type: List                                            â”‚    â”‚
â”‚ â”‚ Value: [                                              â”‚    â”‚
â”‚ â”‚   {sender: "alice", content: "Hello", ts: ...},      â”‚    â”‚
â”‚ â”‚   {sender: "bob", content: "Hi!", ts: ...},          â”‚    â”‚
â”‚ â”‚   ... (last 100 messages)                             â”‚    â”‚
â”‚ â”‚ ]                                                     â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚ Operations:                                                  â”‚
â”‚ - LPUSH: Add new message to list                            â”‚
â”‚ - LTRIM: Keep only last 100 messages                        â”‚
â”‚ - LRANGE: Get recent messages (fast)                        â”‚
â”‚                                                              â”‚
â”‚ Benefits:                                                    â”‚
â”‚ âœ“ Ultra-fast reads (~1ms)                                   â”‚
â”‚ âœ“ Reduces MongoDB load                                      â”‚
â”‚ âœ“ Recent messages always available                          â”‚
â”‚ âœ“ Automatic expiration (optional)                           â”‚
â”‚                                                              â”‚
â”‚ Scaling: 1 pod (can add Redis Cluster for HA)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RabbitMQ Message Queue

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RABBITMQ MESSAGE QUEUE                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Purpose: Reliable async message processing                   â”‚
â”‚                                                              â”‚
â”‚ Queue: message_save                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Properties:                                           â”‚    â”‚
â”‚ â”‚ - Durable: true (survives broker restart)            â”‚    â”‚
â”‚ â”‚ - Persistent: true (messages saved to disk)          â”‚    â”‚
â”‚ â”‚ - Prefetch: 1 (one message per worker at a time)    â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚ Message Format:                                              â”‚
â”‚ {                                                            â”‚
â”‚   "sender": "alice",                                         â”‚
â”‚   "roomId": "room-123",                                      â”‚
â”‚   "content": "Hello world",                                  â”‚
â”‚   "timestamp": "2026-02-08T14:50:00Z"                       â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ Benefits:                                                    â”‚
â”‚ âœ“ Decouples backend from database writes                    â”‚
â”‚ âœ“ Ensures no message loss (persistent)                      â”‚
â”‚ âœ“ Handles traffic spikes (queue buffers)                    â”‚
â”‚ âœ“ Automatic retry on worker failure                         â”‚
â”‚ âœ“ Load distribution across workers                          â”‚
â”‚                                                              â”‚
â”‚ Management UI: Port 15672                                    â”‚
â”‚ AMQP Port: 5672                                              â”‚
â”‚ Scaling: 1 StatefulSet (can add clustering)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Worker Pods

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORKER PODS                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Purpose: Consume queue and persist to MongoDB                â”‚
â”‚                                                              â”‚
â”‚ Process Flow:                                                â”‚
â”‚ 1. Connect to RabbitMQ                                       â”‚
â”‚ 2. Subscribe to 'message_save' queue                         â”‚
â”‚ 3. Wait for messages                                         â”‚
â”‚ 4. On message received:                                      â”‚
â”‚    â”œâ”€â–º Parse JSON                                            â”‚
â”‚    â”œâ”€â–º Create Message model                                  â”‚
â”‚    â”œâ”€â–º Save to MongoDB                                       â”‚
â”‚    â”œâ”€â–º ACK message (success)                                 â”‚
â”‚    â””â”€â–º NACK + requeue (on error)                            â”‚
â”‚                                                              â”‚
â”‚ Error Handling:                                              â”‚
â”‚ - MongoDB connection lost â†’ Retry with backoff               â”‚
â”‚ - Invalid message format â†’ Log and ACK (dead letter)         â”‚
â”‚ - Temporary DB error â†’ NACK and requeue                      â”‚
â”‚                                                              â”‚
â”‚ Scaling: 1-10 pods (HPA based on queue length)              â”‚
â”‚ Concurrency: 1 message per worker (prefetch=1)              â”‚
â”‚                                                              â”‚
â”‚ Benefits:                                                    â”‚
â”‚ âœ“ Backend stays fast (no DB wait)                           â”‚
â”‚ âœ“ Scales independently                                       â”‚
â”‚ âœ“ Handles DB slowness gracefully                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MongoDB StatefulSet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MONGODB STATEFULSET                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Purpose: Persistent data storage                             â”‚
â”‚                                                              â”‚
â”‚ Collections:                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ messages                                              â”‚    â”‚
â”‚ â”‚ {                                                     â”‚    â”‚
â”‚ â”‚   _id: ObjectId,                                      â”‚    â”‚
â”‚ â”‚   sender: String,                                     â”‚    â”‚
â”‚ â”‚   roomId: String,                                     â”‚    â”‚
â”‚ â”‚   content: String,                                    â”‚    â”‚
â”‚ â”‚   timestamp: Date                                     â”‚    â”‚
â”‚ â”‚ }                                                     â”‚    â”‚
â”‚ â”‚ Indexes: roomId, timestamp                            â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚ Storage:                                                     â”‚
â”‚ - PersistentVolumeClaim: 10Gi (dev), 50Gi (prod)           â”‚
â”‚ - StorageClass: Default                                      â”‚
â”‚                                                              â”‚
â”‚ Access Patterns:                                             â”‚
â”‚ - Workers: Write-heavy (INSERT messages)                     â”‚
â”‚ - Backend: Read-light (historical messages)                  â”‚
â”‚ - Most reads served by Redis cache                          â”‚
â”‚                                                              â”‚
â”‚ Benefits:                                                    â”‚
â”‚ âœ“ Permanent message storage                                 â”‚
â”‚ âœ“ Historical message retrieval                              â”‚
â”‚ âœ“ Data analytics and reporting                              â”‚
â”‚ âœ“ Backup and disaster recovery                              â”‚
â”‚                                                              â”‚
â”‚ Scaling: 1 pod (can add replica set for HA)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance Characteristics

| Operation | Component | Latency | Notes |
|-----------|-----------|---------|-------|
| Send message | Backend â†’ Redis | ~1-2ms | In-memory write |
| Broadcast message | Backend â†’ Socket.io | ~5-10ms | Real-time delivery |
| Queue message | Backend â†’ RabbitMQ | ~2-5ms | Async, non-blocking |
| Persist message | Worker â†’ MongoDB | ~20-50ms | Happens async |
| Get recent messages | Backend â†’ Redis | ~1-3ms | Cache hit |
| Get old messages | Backend â†’ MongoDB | ~50-200ms | Database query |

## Failure Scenarios

### Scenario 1: MongoDB is Down

```
âœ… Users can still send/receive messages
   - Redis stores recent messages
   - RabbitMQ queues writes
   - Workers retry when MongoDB recovers
   - No messages lost!
```

### Scenario 2: Redis is Down

```
âš ï¸  Slight degradation
   - Messages still delivered via Socket.io
   - RabbitMQ still queues for persistence
   - Recent message cache unavailable
   - Fall back to MongoDB for history
```

### Scenario 3: RabbitMQ is Down

```
âš ï¸  Temporary persistence issue
   - Real-time messaging still works
   - Redis cache still works
   - New messages not queued for DB
   - Backend logs errors, retries connection
```

### Scenario 4: Worker Pods are Down

```
âš ï¸  Messages queue up
   - Real-time messaging works
   - Redis cache works
   - RabbitMQ buffers messages
   - When workers restart, they process backlog
```

## Scaling Strategy

```
Low Traffic (< 100 users):
- Backend: 2 pods
- Worker: 1 pod
- Redis: 1 pod
- RabbitMQ: 1 pod
- MongoDB: 1 pod

Medium Traffic (100-1000 users):
- Backend: 5 pods (HPA)
- Worker: 2 pods (HPA)
- Redis: 1 pod (consider Redis Cluster)
- RabbitMQ: 1 pod (monitor queue length)
- MongoDB: 1 pod (consider replica set)

High Traffic (1000+ users):
- Backend: 10-20 pods (HPA)
- Worker: 5-10 pods (HPA based on queue)
- Redis: Redis Cluster (3-6 nodes)
- RabbitMQ: Clustered (3 nodes)
- MongoDB: Replica Set (3 nodes)
```

This architecture provides **high availability**, **scalability**, and **fault tolerance**! ğŸš€
